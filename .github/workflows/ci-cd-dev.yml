name: CI/CD Pipeline (DEV)

# ----- Disparador (Trigger) de GitFlow -----
# 'push' está indentado 2 espacios bajo 'on'
on:
  push:
    branches:
      - develop

# Variables de entorno disponibles para todos los jobs
env:
  # Define el nombre completo de la imagen de Docker
  IMAGE_NAME: ${{ secrets.DOCKERHUB_USERNAME }}/mi-api-azure

jobs:
  # ----- Job 1: Integración Continua (CI) -----
  build-and-push:
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.vars.outputs.tag }}

    steps:
      - name: 1. Checkout (Obtener el código)
        uses: actions/checkout@v4

      - name: 2. Generar Tag único para la imagen
        id: vars
        run: |
          echo "tag=$(echo ${GITHUB_SHA} | cut -c1-7)" >> $GITHUB_OUTPUT

      - name: 3. Iniciar sesión en Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: 4. Construir y Subir (Push) la imagen a Docker Hub
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./MiApiAzure.Api/Dockerfile
          push: true
          tags: |
            ${{ env.IMAGE_NAME }}:${{ steps.vars.outputs.tag }}
            ${{ env.IMAGE_NAME }}:latest-dev

  # ----- Job 2: Despliegue Continuo (CD) -----
  deploy-to-dev:
    runs-on: ubuntu-latest
    needs: build-and-push
    environment:
      name: Development
      url: https://app-miapi-dev-lab.azurewebsites.net

    steps:
      - name: 1. Iniciar sesión en Azure
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: 2. Desplegar en Azure App Service (DEV)
        uses: azure/webapps-deploy@v2
        with:
          app-name: "app-miapi-dev-lab"
          images: "${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}"

  # ----- Job 3: Notificación en Slack -----
  notify-slack:
    runs-on: ubuntu-latest
    needs: [build-and-push, deploy-to-dev]
    if: always()

    steps:
      - name: Enviar notificación a Slack
        uses: 8398a7/action-slack@v3
        with:
          status: ${{ job.status }}
          fields: repo,message,commit,author,job,took
          text: |
            *Informe del Pipeline de Desarrollo (MiApiAzure)*
            :hammer_and_wrench: Job de Build: `${{ needs.build-and-push.result }}`
            :rocket: Job de Deploy: `${{ needs.deploy-to-dev.result }}`
            Imagen: `${{ env.IMAGE_NAME }}:${{ needs.build-and-push.outputs.image_tag }}`
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
